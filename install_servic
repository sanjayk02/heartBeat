@echo off
setlocal ENABLEDELAYEDEXPANSION

:: === CONFIGURATION ===
set BASE_DIR=C:\stuff\source\heartBeat
set PYTHON=C:\Program Files\Python39\python.exe
set SERVICE_SCRIPT=%BASE_DIR%\core\inactivity_service.py
set CHECK_SCRIPT=%BASE_DIR%\core\check_agents.py
set VBS_SOURCE=%BASE_DIR%\launch_monitor.vbs
set STARTUP_FOLDER=C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup
set SERVICE_NAME=InactivityMonitorService

:: === HEADER ===
echo.
echo Checking system setup...

:: === Validate Python exists ===
if not exist "%PYTHON%" (
    echo ERROR: Python not found at %PYTHON%
    pause
    exit /b
)

:: === Validate service script ===
if not exist "%SERVICE_SCRIPT%" (
    echo ERROR: Service script not found at %SERVICE_SCRIPT%
    pause
    exit /b
)

:: === Run service check script ===
"%PYTHON%" "%CHECK_SCRIPT%"
if %ERRORLEVEL% NEQ 0 (
    echo Service and task already installed. Skipping setup.
    echo Check logs in: %%USERPROFILE%%\InactivityLogs\
    pause
    exit /b
)

:: === Install Service ===
echo Installing service...
"%PYTHON%" "%SERVICE_SCRIPT%" install

:: === Start Service ===
echo Starting service...
"%PYTHON%" "%SERVICE_SCRIPT%" start
if %ERRORLEVEL% EQU 0 (
    echo Service started successfully.
) else (
    echo Failed to start service.
)

:: === Copy VBS to Startup (for all users) ===
if exist "%VBS_SOURCE%" (
    echo Deploying VBS to global Startup folder...
    copy /Y "%VBS_SOURCE%" "%STARTUP_FOLDER%"
    echo VBS deployed to: %STARTUP_FOLDER%
) else (
    echo VBS file not found at %VBS_SOURCE%. Skipping.
)

:: === Optional Log File ===
echo Logging install time...
echo Installed on %DATE% %TIME% >> "%BASE_DIR%\install_log.txt"

:: === Done ===
echo.
echo Setup complete. Logs will be stored in %%USERPROFILE%%\InactivityLogs\
pause
exit /b
